<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æ¥“ä¹‹è°· å…¬æœƒç®¡ç†å™¨</title>
  <style>
    :root{
      --bg:#0f1724;
      --card:#0b1220;
      --accent:#6ee7b7;
      --accent-hover:#5dd9a6;
      --muted:#94a3b8;
      --glass:rgba(255,255,255,0.04);
      --danger:#ff6b6b;
      --warning:#ffd93d;
      --success:#51cf66;
    }
    *{box-sizing:border-box;font-family:Inter, system-ui, -apple-system, 'Noto Sans TC', 'Microsoft JhengHei', sans-serif}
    body{margin:0;background:linear-gradient(180deg,#071029 0%, #081226 60%);color:#e6eef6;min-height:100vh;padding:18px}
    
    .app{max-width:1600px;margin:0 auto}
    
    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:20px;
      flex-wrap:wrap;
      gap:12px;
    }
    h1{font-size:28px;margin:0;display:flex;align-items:center;gap:10px}
    h1::before{content:'ğŸ';font-size:30px}
    
    .save-indicator{
      font-size:12px;
      color:var(--success);
      padding:5px 12px;
      background:rgba(81,207,102,0.1);
      border-radius:12px;
      border:1px solid rgba(81,207,102,0.2);
    }
    
    .header-actions{display:flex;gap:8px;align-items:center}
    
    /* æ¨™ç±¤é ç³»çµ± */
    .tabs{
      display:flex;
      gap:8px;
      margin-bottom:20px;
      border-bottom:2px solid rgba(255,255,255,0.05);
    }
    .tab{
      padding:12px 24px;
      background:transparent;
      border:none;
      color:var(--muted);
      cursor:pointer;
      transition:all 0.3s;
      font-size:16px;
      font-weight:600;
      border-bottom:3px solid transparent;
      margin-bottom:-2px;
    }
    .tab:hover{
      color:#fff;
      background:rgba(255,255,255,0.05);
    }
    .tab.active{
      color:var(--accent);
      border-bottom-color:var(--accent);
    }
    
    .tab-content{display:none}
    .tab-content.active{display:block}
    
    .card{
      background:var(--card);
      border-radius:12px;
      padding:20px;
      box-shadow:0 6px 18px rgba(2,6,23,0.6);
      border:1px solid rgba(255,255,255,0.03);
      transition:all 0.3s ease;
      margin-bottom:16px;
    }
    .card:hover{border-color:rgba(255,255,255,0.06)}
    
    .card-title{
      font-size:18px;
      font-weight:700;
      margin:0 0 20px 0;
      display:flex;
      align-items:center;
      gap:10px;
      color:var(--accent);
    }
    
    /* è§’è‰²ç®¡ç†é é¢ */
    .char-form{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));
      gap:16px;
      margin-bottom:20px;
    }
    
    .form-group{display:flex;flex-direction:column}
    label{font-size:13px;color:var(--muted);margin-bottom:8px;font-weight:600}
    input[type=text], select, input[type=number], textarea{
      width:100%;
      padding:10px 12px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,0.08);
      background:var(--glass);
      color:inherit;
      transition:all 0.2s;
      font-size:14px;
    }
    textarea{
      min-height:80px;
      resize:vertical;
      font-family:inherit;
    }
    select{
      background:rgba(15,23,36,0.9);
      cursor:pointer;
    }
    select option{
      background:var(--card);
      color:#e6eef6;
    }
    input:focus, select:focus, textarea:focus{
      outline:none;
      border-color:var(--accent);
      background:rgba(110,231,183,0.05);
    }
    
    .checkbox-group{
      display:grid;
      grid-template-columns:repeat(4, 1fr);
      gap:8px;
      margin-top:8px;
    }
    
    .checkbox-label{
      display:flex;
      align-items:center;
      justify-content:center;
      padding:8px;
      background:rgba(255,255,255,0.03);
      border:1px solid rgba(255,255,255,0.06);
      border-radius:8px;
      cursor:pointer;
      transition:all 0.2s;
      font-size:13px;
    }
    .checkbox-label:hover{
      background:rgba(110,231,183,0.1);
      border-color:rgba(110,231,183,0.3);
    }
    .checkbox-label input[type=checkbox]{
      display:none;
    }
    .checkbox-label input[type=checkbox]:checked + span{
      color:var(--accent);
      font-weight:700;
    }
    .checkbox-label:has(input:checked){
      background:rgba(110,231,183,0.15);
      border-color:var(--accent);
    }
    
    button{
      appearance:none;
      border:0;
      padding:12px 20px;
      border-radius:8px;
      background:linear-gradient(135deg,#0ea5a6,#7dd3fc);
      color:#052025;
      font-weight:600;
      cursor:pointer;
      transition:all 0.2s;
      font-size:14px;
    }
    button:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(110,231,183,0.3)}
    button:active{transform:translateY(0)}
    button:disabled{opacity:0.5;cursor:not-allowed;transform:none}
    
    .btn-group{display:flex;gap:10px;margin-top:20px}
    .btn-ghost{
      background:transparent;
      border:1px solid rgba(255,255,255,0.1);
      color:var(--muted);
    }
    .btn-ghost:hover{
      background:rgba(255,255,255,0.05);
      border-color:rgba(255,255,255,0.15);
      color:#fff;
      box-shadow:none;
    }
    
    .btn-danger{
      background:linear-gradient(135deg,#ff6b6b,#ee5a6f);
      color:#fff;
    }
    
    .btn-small{padding:6px 12px;font-size:12px}
    
    /* å ´æ¬¡é¸æ“‡æŒ‰éˆ• */
    .times-btn, .edit-times-btn{
      flex:1;
      padding:8px 16px;
      background:rgba(255,255,255,0.05);
      border:1px solid rgba(255,255,255,0.1);
      color:var(--muted);
      font-size:13px;
      font-weight:600;
      border-radius:6px;
      cursor:pointer;
      transition:all 0.2s;
    }
    .times-btn:hover, .edit-times-btn:hover{
      background:rgba(255,255,255,0.08);
      border-color:rgba(255,255,255,0.2);
      color:#fff;
      transform:none;
      box-shadow:none;
    }
    .times-btn.active, .edit-times-btn.active{
      background:linear-gradient(135deg,#0ea5a6,#7dd3fc);
      border-color:var(--accent);
      color:#052025;
    }
    
    /* è§’è‰²åˆ—è¡¨ */
    .filter-bar{
      display:flex;
      gap:12px;
      margin-bottom:16px;
      align-items:center;
    }
    .filter-bar input{flex:1}
    .filter-bar select{min-width:150px}
    
    .stats-row{
      display:flex;
      gap:16px;
      padding:12px;
      background:rgba(110,231,183,0.08);
      border-radius:8px;
      margin-bottom:16px;
    }
    .stat-item{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:14px;
    }
    .stat-value{font-weight:700;color:var(--accent)}
    
    .char-grid{
      display:grid;
      grid-template-columns:repeat(auto-fill, minmax(280px, 1fr));
      gap:12px;
      max-height:600px;
      overflow-y:auto;
      padding:4px;
    }
    .char-grid::-webkit-scrollbar{width:8px}
    .char-grid::-webkit-scrollbar-track{background:transparent}
    .char-grid::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.15);border-radius:4px}
    
    .char-card{
      background:linear-gradient(135deg, rgba(110,231,183,0.05), rgba(125,211,252,0.03));
      border:1px solid rgba(110,231,183,0.15);
      border-radius:10px;
      padding:14px;
      cursor:grab;
      transition:all 0.2s;
    }
    .char-card:hover{
      border-color:rgba(110,231,183,0.4);
      transform:translateY(-2px);
      box-shadow:0 4px 12px rgba(110,231,183,0.2);
    }
    .char-card.dragging{opacity:0.4;cursor:grabbing}
    
    .char-header{
      display:flex;
      justify-content:space-between;
      align-items:start;
      margin-bottom:10px;
    }
    .char-name{font-size:16px;font-weight:700;margin-bottom:4px}
    .char-job{
      display:inline-block;
      padding:3px 8px;
      border-radius:5px;
      font-size:11px;
      font-weight:600;
      background:rgba(125,211,252,0.15);
      border:1px solid rgba(125,211,252,0.3);
      color:#7dd3fc;
    }
    
    .char-level{font-size:14px;color:var(--muted);margin-bottom:6px}
    .char-damage{
      display:inline-block;
      font-size:11px;
      color:#fbbf24;
      background:rgba(251,191,36,0.1);
      padding:3px 8px;
      border-radius:5px;
      border:1px solid rgba(251,191,36,0.2);
      margin-bottom:6px;
    }
    
    .char-days{
      display:flex;
      flex-wrap:wrap;
      gap:4px;
      font-size:11px;
      margin-bottom:8px;
    }
    .day-badge{
      padding:3px 6px;
      background:rgba(110,231,183,0.15);
      border:1px solid rgba(110,231,183,0.25);
      border-radius:4px;
      color:var(--accent);
    }
    
    .char-time{font-size:11px;color:var(--muted);margin-bottom:8px}
    
    .char-actions{
      display:flex;
      gap:6px;
      margin-top:10px;
    }
    .char-actions button{padding:6px 12px;font-size:12px}
    
    /* ç·¨è¼¯å½ˆçª— */
    .modal{
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background:rgba(0,0,0,0.7);
      backdrop-filter:blur(4px);
      z-index:1000;
      display:none;
      align-items:center;
      justify-content:center;
      padding:20px;
    }
    .modal.show{display:flex}
    
    .modal-content{
      background:var(--card);
      border-radius:12px;
      padding:30px;
      max-width:600px;
      width:100%;
      max-height:90vh;
      overflow-y:auto;
      box-shadow:0 20px 60px rgba(0,0,0,0.5);
      border:1px solid rgba(255,255,255,0.08);
    }
    .modal-content::-webkit-scrollbar{width:8px}
    .modal-content::-webkit-scrollbar-track{background:transparent}
    .modal-content::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.15);border-radius:4px}
    
    .modal-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:24px;
    }
    .modal-title{font-size:20px;font-weight:700;color:var(--accent)}
    .modal-close{
      background:transparent;
      color:var(--muted);
      padding:6px;
      font-size:24px;
      line-height:1;
    }
    .modal-close:hover{color:#fff;transform:none}
    
    .modal-body .form-group{margin-bottom:20px}
    
    .available-chars{
      max-height:700px;
      overflow-y:auto;
      padding:4px;
    }
    .available-chars::-webkit-scrollbar{width:8px}
    .available-chars::-webkit-scrollbar-track{background:transparent}
    .available-chars::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.15);border-radius:4px}
    
    .available-chars-horizontal{
      display:grid;
      grid-template-columns:repeat(auto-fill, minmax(280px, 1fr));
      gap:12px;
      max-height:400px;
      overflow-y:auto;
      padding:4px;
    }
    .available-chars-horizontal::-webkit-scrollbar{height:8px;width:8px}
    .available-chars-horizontal::-webkit-scrollbar-track{background:transparent}
    .available-chars-horizontal::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.15);border-radius:4px}
    
    .teams-container{
      display:grid;
      grid-template-columns:repeat(auto-fill, minmax(350px, 1fr));
      gap:16px;
    }
    
    .team-card{
      background:linear-gradient(135deg, rgba(110,231,183,0.03), rgba(15,23,36,0.5));
      border:2px dashed rgba(110,231,183,0.3);
      border-radius:10px;
      padding:16px;
      transition:all 0.2s;
    }
    .team-card.drag-over{
      border-color:var(--accent);
      background:rgba(110,231,183,0.1);
      transform:scale(1.02);
    }
    
    .team-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:12px;
    }
    .team-title{font-size:16px;font-weight:700;color:var(--accent)}
    .team-count{
      font-size:12px;
      color:var(--muted);
      background:rgba(255,255,255,0.05);
      padding:4px 10px;
      border-radius:12px;
    }
    
    .team-members{
      display:flex;
      flex-direction:column;
      gap:8px;
      min-height:80px;
    }
    .team-members:empty::before{
      content:'å°‡è§’è‰²æ‹–æ›³åˆ°é€™è£¡...';
      display:block;
      text-align:center;
      color:var(--muted);
      font-size:13px;
      padding:30px;
    }
    
    .member-item{
      background:rgba(255,255,255,0.04);
      border:1px solid rgba(255,255,255,0.08);
      border-radius:8px;
      padding:10px 12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      cursor:move;
      transition:all 0.2s;
    }
    .member-item:hover{
      background:rgba(255,255,255,0.08);
      border-color:rgba(110,231,183,0.3);
    }
    .member-item.dragging{opacity:0.4}
    
    .member-info{display:flex;align-items:center;gap:10px}
    .member-name{font-weight:600}
    .member-meta{
      font-size:11px;
      color:var(--muted);
      display:flex;
      gap:8px;
    }
    
    .remove-member{
      padding:4px 8px;
      font-size:11px;
      background:transparent;
      border:1px solid rgba(255,107,107,0.3);
      color:var(--danger);
    }
    .remove-member:hover{
      background:rgba(255,107,107,0.1);
      transform:none;
      box-shadow:none;
    }
    
    /* å‡ºå¸­ç®¡ç†é é¢ */
    .attendance-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:20px;
      flex-wrap:wrap;
      gap:12px;
    }
    
    .week-selector{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .week-selector button{padding:8px 16px}
    .current-week{
      font-size:18px;
      font-weight:700;
      color:var(--accent);
      padding:0 16px;
    }
    
    .attendance-actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    
    .attendance-table-wrapper{
      overflow-x:auto;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.05);
    }
    .attendance-table-wrapper::-webkit-scrollbar{height:8px}
    .attendance-table-wrapper::-webkit-scrollbar-track{background:transparent}
    .attendance-table-wrapper::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.15);border-radius:4px}
    
    .attendance-table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
      background:var(--card);
    }
    
    .attendance-table thead{
      background:rgba(110,231,183,0.08);
      position:sticky;
      top:0;
      z-index:10;
    }
    
    .attendance-table th{
      padding:14px 12px;
      text-align:left;
      font-weight:700;
      color:var(--accent);
      border-bottom:2px solid rgba(110,231,183,0.2);
      white-space:nowrap;
    }
    
    .attendance-table td{
      padding:12px;
      border-bottom:1px solid rgba(255,255,255,0.03);
      vertical-align:middle;
    }
    
    .attendance-table tbody tr{
      transition:background 0.2s;
    }
    .attendance-table tbody tr:hover{
      background:rgba(255,255,255,0.02);
    }
    
    .attendance-name{
      font-weight:600;
      display:flex;
      align-items:center;
      gap:8px;
    }
    
    .attendance-role{
      display:inline-block;
      padding:2px 6px;
      border-radius:4px;
      font-size:10px;
      font-weight:600;
      background:rgba(125,211,252,0.15);
      border:1px solid rgba(125,211,252,0.3);
      color:#7dd3fc;
    }
    
    .level-input{
      width:70px;
      padding:6px 8px;
      font-size:13px;
      text-align:center;
    }
    
    .level-compare{
      font-size:11px;
      margin-left:6px;
    }
    .level-up{color:var(--success)}
    .level-down{color:var(--danger)}
    .level-same{color:var(--muted)}
    
    .status-toggle{
      padding:6px 12px;
      font-size:12px;
      border-radius:6px;
      cursor:pointer;
      transition:all 0.2s;
      border:1px solid rgba(255,255,255,0.1);
      background:rgba(255,255,255,0.03);
      color:var(--muted);
      white-space:nowrap;
    }
    .status-toggle:hover{
      background:rgba(255,255,255,0.08);
      border-color:rgba(255,255,255,0.2);
      transform:none;
      box-shadow:none;
    }
    .status-toggle.active{
      background:linear-gradient(135deg,#51cf66,#40c057);
      border-color:var(--success);
      color:#fff;
    }
    
    .notes-input{
      width:100%;
      min-width:150px;
      padding:6px 8px;
      font-size:12px;
    }
    
    .action-cell{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
    }
    .action-cell button{
      padding:6px 12px;
      font-size:11px;
      white-space:nowrap;
    }
    
    /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
    @media(max-width: 768px){
      .char-form{grid-template-columns:1fr}
      .checkbox-group{grid-template-columns:repeat(2, 1fr)}
      .stats-row{flex-direction:column}
      .char-grid{grid-template-columns:1fr}
      
      .attendance-table{font-size:11px}
      .attendance-table th, .attendance-table td{padding:8px 6px}
      
      /* è¡¨å–®åº•éƒ¨å€åŸŸåœ¨å°è¢å¹•ä¸Šæ”¹ç‚ºå…©è¡Œ */
      .form-bottom-row{
        grid-template-columns:1fr 1fr !important;
      }
      .form-bottom-row > div:nth-child(2){
        grid-column:1 / -1;
      }
      
      /* éšŠä¼å®¹å™¨åœ¨å°è¢å¹•ä¸Šå–®åˆ—é¡¯ç¤º */
      .teams-container{
        grid-template-columns:1fr !important;
      }
    }
    
    /* å°å‹æŒ‰éˆ•æ¨£å¼å„ªåŒ– */
    .btn-edit, .btn-delete{
      padding:6px 12px;
      font-size:12px;
    }
    
    /* è«‹å‡ç‹€æ…‹æ¨£å¼ */
    .on-leave{
      opacity:0.6;
      background:rgba(255,107,107,0.05) !important;
    }
    
    .leave-badge{
      display:inline-block;
      padding:3px 8px;
      border-radius:5px;
      font-size:11px;
      font-weight:600;
      background:rgba(255,107,107,0.15);
      border:1px solid rgba(255,107,107,0.3);
      color:var(--danger);
      margin-left:8px;
    }
    
    .return-date{
      font-size:11px;
      color:var(--muted);
      margin-left:4px;
    }

    /* åˆªé™¤æŒ‰éˆ•æ¨£å¼ */
    .btn-delete-data{
      background:linear-gradient(135deg,#dc2626,#991b1b);
      color:#fff;
      padding:6px 12px;
      font-size:11px;
    }
    .btn-delete-data:hover{
      background:linear-gradient(135deg,#b91c1c,#7f1d1d);
    }
  </style>
</head>
<body>

<div class="app">
  <header>
    <h1>æ¥“ä¹‹è°· å…¬æœƒç®¡ç†å™¨</h1>
    <div class="header-actions">
      <div class="save-indicator" id="saveIndicator">âœ“ å·²è‡ªå‹•å„²å­˜</div>
      <button class="btn-danger btn-small" onclick="deleteAllData()">ğŸ—‘ï¸ åˆªé™¤å…¨éƒ¨è³‡æ–™</button>
      <button class="btn-ghost btn-small" onclick="exportData()">åŒ¯å‡ºè³‡æ–™</button>
      <button class="btn-ghost btn-small" onclick="importData()">åŒ¯å…¥è³‡æ–™</button>
    </div>
  </header>
  
  <div class="tabs">
    <button class="tab active" onclick="switchTab('chars')">ğŸ‘¥ è§’è‰²ç®¡ç†</button>
    <button class="tab" onclick="switchTab('teams')">ğŸ›¡ï¸ éšŠä¼ç®¡ç†</button>
    <button class="tab" onclick="switchTab('attendance')">ğŸ“‹ å‡ºå¸­ç®¡ç†</button>
  </div>
  
  <!-- è§’è‰²ç®¡ç†é é¢ -->
  <div id="charsTab" class="tab-content active">
    <div class="card">
      <h2 class="card-title">â• æ–°å¢è§’è‰²</h2>
      <div class="char-form">
        <div class="form-group">
          <label>è§’è‰²åç¨± *</label>
          <input type="text" id="nameInput" placeholder="è¼¸å…¥è§’è‰²åç¨±" />
        </div>
        
        <div class="form-group">
          <label>è·æ¥­</label>
          <select id="jobInput">
            <option value="">é¸æ“‡è·æ¥­ï¼ˆé¸å¡«ï¼‰</option>
            <option value="åå­—è»">åå­—è»</option>
            <option value="é¨å£«">é¨å£«</option>
            <option value="é¾é¨å£«">é¾é¨å£«</option>
            <option value="å¼“ç®­æ‰‹">å¼“ç®­æ‰‹</option>
            <option value="å¼©å¼“æ‰‹">å¼©å¼“æ‰‹</option>
            <option value="å†°é›·å¤§æ³•å¸«">å†°é›·å¤§æ³•å¸«</option>
            <option value="ç«æ¯’å¤§æ³•å¸«">ç«æ¯’å¤§æ³•å¸«</option>
            <option value="ç¥­å¸">ç¥­å¸</option>
            <option value="ä¿ ç›œï¼ˆåˆ€è³Šï¼‰">ä¿ ç›œï¼ˆåˆ€è³Šï¼‰</option>
            <option value="åˆºå®¢ï¼ˆé¢è³Šï¼‰">åˆºå®¢ï¼ˆé¢è³Šï¼‰</option>
            <option value="æ ¼é¬¥å®¶">æ ¼é¬¥å®¶</option>
            <option value="ç¥æ§æ‰‹">ç¥æ§æ‰‹</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>ç­‰ç´š *</label>
          <input type="number" id="levelInput" placeholder="ä¾‹å¦‚ï¼š250" min="1" max="300" />
        </div>
        
        <div class="form-group">
          <label>æˆ°åŠ›ï¼ˆé¸å¡«ï¼‰</label>
          <input type="text" id="damageInput" placeholder="ä¾‹å¦‚ï¼š500E" />
        </div>
      </div>
      
      <div class="form-group" style="margin-top:20px">
        <label>å¯ä¸Šç·šå¤©æ•¸</label>
        <div class="checkbox-group">
          <label class="checkbox-label">
            <input type="checkbox" id="day1" value="ä¸€" />
            <span>é€±ä¸€</span>
          </label>
          <label class="checkbox-label">
            <input type="checkbox" id="day2" value="äºŒ" />
            <span>é€±äºŒ</span>
          </label>
          <label class="checkbox-label">
            <input type="checkbox" id="day3" value="ä¸‰" />
            <span>é€±ä¸‰</span>
          </label>
          <label class="checkbox-label">
            <input type="checkbox" id="day4" value="å››" />
            <span>é€±å››</span>
          </label>
          <label class="checkbox-label">
            <input type="checkbox" id="day5" value="äº”" />
            <span>é€±äº”</span>
          </label>
          <label class="checkbox-label">
            <input type="checkbox" id="day6" value="å…­" />
            <span>é€±å…­</span>
          </label>
          <label class="checkbox-label">
            <input type="checkbox" id="day7" value="æ—¥" />
            <span>é€±æ—¥</span>
          </label>
          <label class="checkbox-label">
            <input type="checkbox" id="dayAll" value="å…¨é€±" />
            <span>å…¨é€±</span>
          </label>
        </div>
      </div>
      
      <div class="form-bottom-row" style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:16px;margin-top:20px;align-items:end">
        <div class="form-group" style="margin:0">
          <label>å¯ä¸Šç·šæ™‚æ®µï¼ˆé¸å¡«ï¼‰</label>
          <select id="timeSlot">
            <option value="">è«‹é¸æ“‡æ™‚æ®µ</option>
            <option value="00:00">00:00</option>
            <option value="01:00">01:00</option>
            <option value="02:00">02:00</option>
            <option value="03:00">03:00</option>
            <option value="04:00">04:00</option>
            <option value="05:00">05:00</option>
            <option value="06:00">06:00</option>
            <option value="07:00">07:00</option>
            <option value="08:00">08:00</option>
            <option value="09:00">09:00</option>
            <option value="10:00">10:00</option>
            <option value="11:00">11:00</option>
            <option value="12:00">12:00</option>
            <option value="13:00">13:00</option>
            <option value="14:00">14:00</option>
            <option value="15:00">15:00</option>
            <option value="16:00">16:00</option>
            <option value="17:00">17:00</option>
            <option value="18:00">18:00</option>
            <option value="19:00">19:00</option>
            <option value="20:00">20:00</option>
            <option value="21:00">21:00</option>
            <option value="22:00">22:00</option>
            <option value="23:00">23:00</option>
          </select>
        </div>
        
        <div class="form-group" style="margin:0">
          <label>æ¯é€±å ´æ¬¡</label>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="times-btn active" data-times="0" onclick="selectTimes(0)">0å ´</button>
            <button class="times-btn" data-times="7" onclick="selectTimes(7)">7å ´</button>
            <button class="times-btn" data-times="14" onclick="selectTimes(14)">14å ´</button>
          </div>
        </div>
        
        <div style="display:flex;flex-direction:column;gap:8px">
          <button id="addBtn">â• æ–°å¢è§’è‰²</button>
        </div>
        
        <div style="display:flex;flex-direction:column;gap:8px">
          <button class="btn-ghost" id="clearBtn">ğŸ”„ æ¸…é™¤è¡¨å–®</button>
        </div>
      </div>
    </div>
    
    <div class="card">
      <h2 class="card-title">ğŸ“Š è§’è‰²åˆ—è¡¨</h2>
      
      <div class="filter-bar">
        <input type="text" id="filterName" placeholder="ğŸ” æœå°‹è§’è‰²åç¨±..." />
        <select id="filterJob">
          <option value="">æ‰€æœ‰è·æ¥­</option>
          <option value="åå­—è»">åå­—è»</option>
          <option value="é¨å£«">é¨å£«</option>
          <option value="é¾é¨å£«">é¾é¨å£«</option>
          <option value="å¼“ç®­æ‰‹">å¼“ç®­æ‰‹</option>
          <option value="å¼©å¼“æ‰‹">å¼©å¼“æ‰‹</option>
          <option value="å†°é›·å¤§æ³•å¸«">å†°é›·å¤§æ³•å¸«</option>
          <option value="ç«æ¯’å¤§æ³•å¸«">ç«æ¯’å¤§æ³•å¸«</option>
          <option value="ç¥­å¸">ç¥­å¸</option>
          <option value="ä¿ ç›œï¼ˆåˆ€è³Šï¼‰">ä¿ ç›œï¼ˆåˆ€è³Šï¼‰</option>
          <option value="åˆºå®¢ï¼ˆé¢è³Šï¼‰">åˆºå®¢ï¼ˆé¢è³Šï¼‰</option>
          <option value="æ ¼é¬¥å®¶">æ ¼é¬¥å®¶</option>
          <option value="ç¥æ§æ‰‹">ç¥æ§æ‰‹</option>
        </select>
      </div>
      
      <div class="stats-row" id="statsRow"></div>
      
      <div class="char-grid" id="charList"></div>
    </div>
  </div>
  
  <!-- éšŠä¼ç®¡ç†é é¢ -->
  <div id="teamsTab" class="tab-content">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
        <h2 class="card-title" style="margin:0">ğŸ‘¥ å¯ç”¨è§’è‰²</h2>
      </div>
      
      <div class="filter-bar" style="margin-bottom:16px">
        <input type="text" id="teamFilterName" placeholder="ğŸ” æœå°‹è§’è‰²..." style="flex:1" />
        <select id="teamFilterJob" style="min-width:150px">
          <option value="">æ‰€æœ‰è·æ¥­</option>
          <option value="åå­—è»">åå­—è»</option>
          <option value="é¨å£«">é¨å£«</option>
          <option value="é¾é¨å£«">é¾é¨å£«</option>
          <option value="å¼“ç®­æ‰‹">å¼“ç®­æ‰‹</option>
          <option value="å¼©å¼“æ‰‹">å¼©å¼“æ‰‹</option>
          <option value="å†°é›·å¤§æ³•å¸«">å†°é›·å¤§æ³•å¸«</option>
          <option value="ç«æ¯’å¤§æ³•å¸«">ç«æ¯’å¤§æ³•å¸«</option>
          <option value="ç¥­å¸">ç¥­å¸</option>
          <option value="ä¿ ç›œï¼ˆåˆ€è³Šï¼‰">ä¿ ç›œï¼ˆåˆ€è³Šï¼‰</option>
          <option value="åˆºå®¢ï¼ˆé¢è³Šï¼‰">åˆºå®¢ï¼ˆé¢è³Šï¼‰</option>
          <option value="æ ¼é¬¥å®¶">æ ¼é¬¥å®¶</option>
          <option value="ç¥æ§æ‰‹">ç¥æ§æ‰‹</option>
        </select>
        <select id="teamFilterDay" style="min-width:120px">
          <option value="">æ‰€æœ‰å¤©æ•¸</option>
          <option value="ä¸€">é€±ä¸€</option>
          <option value="äºŒ">é€±äºŒ</option>
          <option value="ä¸‰">é€±ä¸‰</option>
          <option value="å››">é€±å››</option>
          <option value="äº”">é€±äº”</option>
          <option value="å…­">é€±å…­</option>
          <option value="æ—¥">é€±æ—¥</option>
        </select>
      </div>
      
      <div class="available-chars-horizontal" id="availableChars"></div>
    </div>
    
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
        <h2 class="card-title" style="margin:0">ğŸ›¡ï¸ éšŠä¼é…ç½®</h2>
        <div style="display:flex;gap:8px">
          <button class="btn-ghost btn-small" onclick="addTeam()">â• æ–°å¢éšŠä¼</button>
          <button class="btn-ghost btn-small" onclick="clearAllTeams()">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰</button>
        </div>
      </div>
      
      <div class="teams-container" id="teamsContainer"></div>
    </div>
  </div>
  
  <!-- å‡ºå¸­ç®¡ç†é é¢ -->
  <div id="attendanceTab" class="tab-content">
    <div class="card">
      <div class="attendance-header">
        <div class="week-selector">
          <button class="btn-ghost btn-small" onclick="changeWeek(-1)">â† ä¸Šé€±</button>
          <div class="current-week" id="currentWeekDisplay"></div>
          <button class="btn-ghost btn-small" onclick="changeWeek(1)">ä¸‹é€± â†’</button>
        </div>
        
        <div class="attendance-actions">
          <button class="btn-small" onclick="batchUpdateLevels()">æ‰¹é‡æ›´æ–°ç­‰ç´š</button>
          <button class="btn-small" onclick="generateWeeklyReport()">ç”Ÿæˆé€±å ±</button>
          <button class="btn-ghost btn-small" onclick="viewHistory()">æŸ¥çœ‹æ­·å²</button>
          <button class="btn-ghost btn-small" onclick="compareWeeks()">é€±æ•¸å°æ¯”</button>
        </div>
      </div>
      
      <div class="attendance-table-wrapper">
        <table class="attendance-table">
          <thead>
            <tr>
              <th style="min-width:150px">è§’è‰²åç¨±</th>
              <th style="min-width:80px">èº«ä»½</th>
              <th style="min-width:100px">ä¸Šé€±ç­‰ç´š</th>
              <th style="min-width:100px">ç¾åœ¨ç­‰ç´š</th>
              <th style="min-width:100px">ç·´åŠŸ</th>
              <th style="min-width:100px">è«‹å‡</th>
              <th style="min-width:200px">å‚™è¨»</th>
              <th style="min-width:200px">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="attendanceBody">
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- ç·¨è¼¯è§’è‰²å½ˆçª— -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">âœï¸ ç·¨è¼¯è§’è‰²</h3>
      <button class="modal-close" onclick="closeEditModal()">Ã—</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="editCharId" />
      
      <div class="form-group">
        <label>è§’è‰²åç¨± *</label>
        <input type="text" id="editName" />
      </div>
      
      <div class="form-group">
        <label>ç­‰ç´š *</label>
        <input type="number" id="editLevel" min="1" max="300" />
      </div>
      
      <div class="form-group">
        <label>è·æ¥­</label>
        <select id="editJob">
          <option value="">é¸æ“‡è·æ¥­ï¼ˆé¸å¡«ï¼‰</option>
          <option value="åå­—è»">åå­—è»</option>
          <option value="é¨å£«">é¨å£«</option>
          <option value="é¾é¨å£«">é¾é¨å£«</option>
          <option value="å¼“ç®­æ‰‹">å¼“ç®­æ‰‹</option>
          <option value="å¼©å¼“æ‰‹">å¼©å¼“æ‰‹</option>
          <option value="å†°é›·å¤§æ³•å¸«">å†°é›·å¤§æ³•å¸«</option>
          <option value="ç«æ¯’å¤§æ³•å¸«">ç«æ¯’å¤§æ³•å¸«</option>
          <option value="ç¥­å¸">ç¥­å¸</option>
          <option value="ä¿ ç›œï¼ˆåˆ€è³Šï¼‰">ä¿ ç›œï¼ˆåˆ€è³Šï¼‰</option>
          <option value="åˆºå®¢ï¼ˆé¢è³Šï¼‰">åˆºå®¢ï¼ˆé¢è³Šï¼‰</option>
          <option value="æ ¼é¬¥å®¶">æ ¼é¬¥å®¶</option>
          <option value="ç¥æ§æ‰‹">ç¥æ§æ‰‹</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>æˆ°åŠ›ï¼ˆé¸å¡«ï¼‰</label>
        <input type="text" id="editDamage" />
      </div>
      
      <div class="form-group">
        <label>å¯ä¸Šç·šå¤©æ•¸</label>
        <div class="checkbox-group">
          <label class="checkbox-label">
            <input type="checkbox" id="editDay1" value="ä¸€" />
            <span>é€±ä¸€</span>
          </label>
          <label class="checkbox-label">
            <input type="checkbox" id="editDay2" value="äºŒ" />
            <span>é€±äºŒ</span>
          </label>
          <label class="checkbox-label">
            <input type="checkbox" id="editDay3" value="ä¸‰" />
            <span>é€±ä¸‰</span>
          </label>
          <label class="checkbox-label">
            <input type="checkbox" id="editDay4" value="å››" />
            <span>é€±å››</span>
          </label>
          <label class="checkbox-label">
            <input type="checkbox" id="editDay5" value="äº”" />
            <span>é€±äº”</span>
          </label>
          <label class="checkbox-label">
            <input type="checkbox" id="editDay6" value="å…­" />
            <span>é€±å…­</span>
          </label>
          <label class="checkbox-label">
            <input type="checkbox" id="editDay7" value="æ—¥" />
            <span>é€±æ—¥</span>
          </label>
          <label class="checkbox-label">
            <input type="checkbox" id="editDayAll" value="å…¨é€±" />
            <span>å…¨é€±</span>
          </label>
        </div>
      </div>
      
      <div class="form-group">
        <label>å¯ä¸Šç·šæ™‚æ®µ</label>
        <select id="editTimeSlot">
          <option value="">è«‹é¸æ“‡æ™‚æ®µ</option>
          <option value="00:00">00:00</option>
          <option value="01:00">01:00</option>
          <option value="02:00">02:00</option>
          <option value="03:00">03:00</option>
          <option value="04:00">04:00</option>
          <option value="05:00">05:00</option>
          <option value="06:00">06:00</option>
          <option value="07:00">07:00</option>
          <option value="08:00">08:00</option>
          <option value="09:00">09:00</option>
          <option value="10:00">10:00</option>
          <option value="11:00">11:00</option>
          <option value="12:00">12:00</option>
          <option value="13:00">13:00</option>
          <option value="14:00">14:00</option>
          <option value="15:00">15:00</option>
          <option value="16:00">16:00</option>
          <option value="17:00">17:00</option>
          <option value="18:00">18:00</option>
          <option value="19:00">19:00</option>
          <option value="20:00">20:00</option>
          <option value="21:00">21:00</option>
          <option value="22:00">22:00</option>
          <option value="23:00">23:00</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>æ¯é€±å ´æ¬¡</label>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="edit-times-btn" data-times="0" onclick="selectEditTimes(0)">0å ´</button>
          <button class="edit-times-btn" data-times="7" onclick="selectEditTimes(7)">7å ´</button>
          <button class="edit-times-btn" data-times="14" onclick="selectEditTimes(14)">14å ´</button>
        </div>
      </div>
      
      <div class="btn-group">
        <button onclick="saveEdit()">ğŸ’¾ å„²å­˜è®Šæ›´</button>
        <button class="btn-ghost" onclick="closeEditModal()">å–æ¶ˆ</button>
      </div>
    </div>
  </div>
</div>

<script>
// ==================== è³‡æ–™çµæ§‹ ====================
let chars = [];
let teams = [];
let attendance = {};
let selectedTimes = 0; // é è¨­ç‚º0å ´
let editSelectedTimes = 0; // é è¨­ç‚º0å ´

// é€±æ¬¡ç›¸é—œ
let currentWeekKey = getCurrentWeekKey();

function getCurrentWeekKey(){
  const now = new Date();
  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const day = String(now.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

function changeWeek(offset){
  const parts = currentWeekKey.split('-');
  const date = new Date(parts[0], parts[1] - 1, parts[2]);
  date.setDate(date.getDate() + (offset * 7));
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  currentWeekKey = `${year}-${month}-${day}`;
  renderAttendance();
}

function getWeekDisplay(weekKey){
  const parts = weekKey.split('-');
  const date = new Date(parts[0], parts[1] - 1, parts[2]);
  const year = date.getFullYear();
  const month = date.getMonth() + 1;
  const day = date.getDate();
  return `${year}å¹´${month}æœˆ${day}æ—¥ ç•¶é€±`;
}

function getPreviousWeekKey(weekKey){
  const parts = weekKey.split('-');
  const date = new Date(parts[0], parts[1] - 1, parts[2]);
  date.setDate(date.getDate() - 7);
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

// ==================== æœ¬åœ°å„²å­˜ ====================
function saveToLocal(){
  try{
    localStorage.setItem('msChars', JSON.stringify(chars));
    localStorage.setItem('msTeams', JSON.stringify(teams));
    localStorage.setItem('msAttendance', JSON.stringify(attendance));
    showSaveIndicator();
  } catch(e){
    alert('å„²å­˜å¤±æ•—ï¼å¯èƒ½æ˜¯ç€è¦½å™¨å„²å­˜ç©ºé–“å·²æ»¿ã€‚');
  }
}

function loadFromLocal(){
  try{
    const savedChars = localStorage.getItem('msChars');
    const savedTeams = localStorage.getItem('msTeams');
    const savedAttendance = localStorage.getItem('msAttendance');
    
    if(savedChars) {
      chars = JSON.parse(savedChars);
      // è³‡æ–™é·ç§»ï¼šå°‡èˆŠæ ¼å¼è½‰æ›ç‚ºæ–°æ ¼å¼
      chars = chars.map(c => {
        // å°‡ availableDays è½‰æ›ç‚º days
        if(c.availableDays && !c.days){
          c.days = c.availableDays;
          delete c.availableDays;
        }
        // å°‡ timeStart è½‰æ›ç‚º timeSlot
        if(c.timeStart && !c.timeSlot){
          c.timeSlot = c.timeStart;
          delete c.timeStart;
          delete c.timeEnd; // åˆªé™¤ä¸å†ä½¿ç”¨çš„ timeEnd
        }
        // ç¢ºä¿ times æ¬„ä½å­˜åœ¨
        if(c.times === undefined){
          c.times = 0; // é è¨­ç‚º0å ´
        }
        // ç¢ºä¿ days æ¬„ä½å­˜åœ¨ä¸”ä¸ç‚ºç©º
        if(!c.days || c.days.length === 0){
          c.days = ['å…¨é€±']; // é è¨­ç‚ºå…¨é€±
        }
        return c;
      });
    }
    if(savedTeams) teams = JSON.parse(savedTeams);
    if(savedAttendance) {
      attendance = JSON.parse(savedAttendance);
      // é·ç§»å‡ºå¸­è³‡æ–™æ ¼å¼
      Object.keys(attendance).forEach(weekKey => {
        Object.keys(attendance[weekKey]).forEach(charId => {
          const data = attendance[weekKey][charId];
          // ç§»é™¤ inGuild æ¬„ä½
          if(data.inGuild !== undefined){
            delete data.inGuild;
          }
          // ç¢ºä¿æœ‰ lastWeekLevel æ¬„ä½
          if(data.lastWeekLevel === undefined){
            data.lastWeekLevel = '';
          }
          // ç¢ºä¿æœ‰ currentLevel æ¬„ä½
          if(data.currentLevel === undefined){
            data.currentLevel = '';
          }
        });
      });
    }
    
    renderChars();
    renderTeams();
    renderAvailableChars();
    renderAttendance();
  } catch(e){
    console.error('è®€å–è³‡æ–™å¤±æ•—ï¼š', e);
  }
}

function showSaveIndicator(){
  const indicator = document.getElementById('saveIndicator');
  indicator.style.opacity = '1';
  setTimeout(() => {
    indicator.style.opacity = '0.7';
  }, 300);
}

// ==================== æ¨™ç±¤é åˆ‡æ› ====================
function switchTab(tab){
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
  
  event.target.classList.add('active');
  document.getElementById(`${tab}Tab`).classList.add('active');
  
  if(tab === 'attendance'){
    renderAttendance();
  }
}

// ==================== å ´æ¬¡é¸æ“‡ ====================
function selectTimes(times){
  selectedTimes = times;
  document.querySelectorAll('.times-btn').forEach(btn => {
    btn.classList.remove('active');
    if(parseInt(btn.dataset.times) === times){
      btn.classList.add('active');
    }
  });
}

function selectEditTimes(times){
  editSelectedTimes = times;
  document.querySelectorAll('.edit-times-btn').forEach(btn => {
    btn.classList.remove('active');
    if(parseInt(btn.dataset.times) === times){
      btn.classList.add('active');
    }
  });
}

// ==================== è§’è‰²ç®¡ç† ====================
function addChar(){
  const name = document.getElementById('nameInput').value.trim();
  const level = parseInt(document.getElementById('levelInput').value);
  const job = document.getElementById('jobInput').value;
  const damage = document.getElementById('damageInput').value.trim();
  
  if(!name){
    alert('è«‹è¼¸å…¥è§’è‰²åç¨±ï¼');
    return;
  }
  if(!level || level < 1 || level > 300){
    alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„ç­‰ç´šï¼ˆ1-300ï¼‰ï¼');
    return;
  }
  
  const days = getSelectedDays();
  if(days.length === 0){
    alert('è«‹é¸æ“‡è‡³å°‘ä¸€å€‹å¯ä¸Šç·šå¤©æ•¸ï¼');
    return;
  }
  
  const timeSlot = document.getElementById('timeSlot').value;
  
  const newChar = {
    id: Date.now(),
    name,
    level,
    job: job || 'æœªåˆ†é¡',
    damage: damage || '',
    days,
    timeSlot: timeSlot || '',
    times: selectedTimes,
    role: 'æˆå“¡'
  };
  
  chars.push(newChar);
  saveToLocal();
  renderChars();
  renderAvailableChars();
  
  // æ¸…ç©ºè¡¨å–®
  document.getElementById('clearBtn').click();
}

function getSelectedDays(){
  const days = [];
  const dayAll = document.getElementById('dayAll').checked;
  if(dayAll){
    return ['å…¨é€±'];
  }
  for(let i = 1; i <= 7; i++){
    const checkbox = document.getElementById(`day${i}`);
    if(checkbox.checked){
      days.push(checkbox.value);
    }
  }
  return days;
}

function setSelectedDays(days){
  document.getElementById('dayAll').checked = false;
  for(let i = 1; i <= 7; i++){
    document.getElementById(`day${i}`).checked = false;
  }
  
  if(days.includes('å…¨é€±')){
    document.getElementById('dayAll').checked = true;
  } else {
    const dayMap = {'ä¸€': 1, 'äºŒ': 2, 'ä¸‰': 3, 'å››': 4, 'äº”': 5, 'å…­': 6, 'æ—¥': 7};
    days.forEach(d => {
      const idx = dayMap[d];
      if(idx) document.getElementById(`day${idx}`).checked = true;
    });
  }
}

function renderChars(){
  const filterName = document.getElementById('filterName').value.toLowerCase();
  const filterJob = document.getElementById('filterJob').value;
  
  const filtered = chars.filter(c => {
    const matchName = c.name.toLowerCase().includes(filterName);
    const matchJob = !filterJob || c.job === filterJob;
    return matchName && matchJob;
  }).sort((a, b) => b.level - a.level); // æŒ‰ç­‰ç´šå¾é«˜åˆ°ä½æ’åº
  
  // çµ±è¨ˆ
  const totalChars = chars.length;
  const avgLevel = chars.length > 0 ? Math.round(chars.reduce((sum, c) => sum + c.level, 0) / chars.length) : 0;
  const maxLevel = chars.length > 0 ? Math.max(...chars.map(c => c.level)) : 0;
  
  document.getElementById('statsRow').innerHTML = `
    <div class="stat-item">
      <span>ç¸½äººæ•¸ï¼š</span>
      <span class="stat-value">${totalChars}</span>
    </div>
    <div class="stat-item">
      <span>å¹³å‡ç­‰ç´šï¼š</span>
      <span class="stat-value">${avgLevel}</span>
    </div>
    <div class="stat-item">
      <span>æœ€é«˜ç­‰ç´šï¼š</span>
      <span class="stat-value">${maxLevel}</span>
    </div>
  `;
  
  const html = filtered.map(c => {
    const days = c.days || ['å…¨é€±'];
    const times = c.times !== undefined ? c.times : 0;
    const timeSlot = c.timeSlot || '';
    
    return `
    <div class="char-card" draggable="true" data-char-id="${c.id}">
      <div class="char-header">
        <div>
          <div class="char-name">${c.name}</div>
          <span class="char-job">${c.job || 'æœªåˆ†é¡'}</span>
        </div>
      </div>
      <div class="char-level">ç­‰ç´š ${c.level}</div>
      ${c.damage ? `<div class="char-damage">ğŸ’¥ ${c.damage}</div>` : ''}
      <div class="char-days">
        ${days.map(d => `<span class="day-badge">${d}</span>`).join('')}
      </div>
      ${timeSlot ? `<div class="char-time">â° ${timeSlot}</div>` : ''}
      <div class="char-time">ğŸ® æ¯é€± ${times} å ´</div>
      <div class="char-actions">
        <button class="btn-small" onclick="editChar(${c.id})">âœï¸ ç·¨è¼¯</button>
        <button class="btn-small btn-danger" onclick="deleteChar(${c.id})">ğŸ—‘ï¸ åˆªé™¤</button>
      </div>
    </div>
  `}).join('');
  
  document.getElementById('charList').innerHTML = html || '<p style="text-align:center;color:var(--muted);padding:40px">å°šç„¡è§’è‰²è³‡æ–™</p>';
  
  setupDragDrop();
}

function editChar(id){
  const char = chars.find(c => c.id === id);
  if(!char) return;
  
  document.getElementById('editCharId').value = char.id;
  document.getElementById('editName').value = char.name;
  document.getElementById('editLevel').value = char.level;
  document.getElementById('editJob').value = char.job === 'æœªåˆ†é¡' ? '' : char.job;
  document.getElementById('editDamage').value = char.damage || '';
  document.getElementById('editTimeSlot').value = char.timeSlot || '';
  
  // è¨­å®šå¤©æ•¸
  document.getElementById('editDayAll').checked = false;
  for(let i = 1; i <= 7; i++){
    document.getElementById(`editDay${i}`).checked = false;
  }
  
  // ç¢ºä¿ days æ¬„ä½å­˜åœ¨
  const days = char.days || ['å…¨é€±'];
  if(days.includes('å…¨é€±')){
    document.getElementById('editDayAll').checked = true;
  } else {
    const dayMap = {'ä¸€': 1, 'äºŒ': 2, 'ä¸‰': 3, 'å››': 4, 'äº”': 5, 'å…­': 6, 'æ—¥': 7};
    days.forEach(d => {
      const idx = dayMap[d];
      if(idx) document.getElementById(`editDay${idx}`).checked = true;
    });
  }
  
  // è¨­å®šå ´æ¬¡
  editSelectedTimes = char.times !== undefined ? char.times : 0;
  document.querySelectorAll('.edit-times-btn').forEach(btn => {
    btn.classList.remove('active');
    if(parseInt(btn.dataset.times) === editSelectedTimes){
      btn.classList.add('active');
    }
  });
  
  document.getElementById('editModal').classList.add('show');
}

function closeEditModal(){
  document.getElementById('editModal').classList.remove('show');
}

function saveEdit(){
  const id = parseInt(document.getElementById('editCharId').value);
  const char = chars.find(c => c.id === id);
  if(!char) return;
  
  const name = document.getElementById('editName').value.trim();
  const level = parseInt(document.getElementById('editLevel').value);
  const job = document.getElementById('editJob').value;
  const damage = document.getElementById('editDamage').value.trim();
  
  if(!name){
    alert('è«‹è¼¸å…¥è§’è‰²åç¨±ï¼');
    return;
  }
  if(!level || level < 1 || level > 300){
    alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„ç­‰ç´šï¼ˆ1-300ï¼‰ï¼');
    return;
  }
  
  const days = getEditSelectedDays();
  if(days.length === 0){
    alert('è«‹é¸æ“‡è‡³å°‘ä¸€å€‹å¯ä¸Šç·šå¤©æ•¸ï¼');
    return;
  }
  
  const timeSlot = document.getElementById('editTimeSlot').value;
  
  char.name = name;
  char.level = level;
  char.job = job || 'æœªåˆ†é¡';
  char.damage = damage;
  char.days = days;
  char.timeSlot = timeSlot;
  char.times = editSelectedTimes;
  
  saveToLocal();
  renderChars();
  renderAvailableChars();
  renderAttendance();
  closeEditModal();
}

function getEditSelectedDays(){
  const days = [];
  const dayAll = document.getElementById('editDayAll').checked;
  if(dayAll){
    return ['å…¨é€±'];
  }
  for(let i = 1; i <= 7; i++){
    const checkbox = document.getElementById(`editDay${i}`);
    if(checkbox.checked){
      days.push(checkbox.value);
    }
  }
  return days;
}

function deleteChar(id){
  if(!confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹è§’è‰²å—ï¼Ÿ\n\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')){
    return;
  }
  chars = chars.filter(c => c.id !== id);
  
  // åŒæ™‚å¾éšŠä¼ä¸­ç§»é™¤
  teams.forEach(team => {
    team.members = team.members.filter(mid => mid !== id);
  });
  
  saveToLocal();
  renderChars();
  renderTeams();
  renderAvailableChars();
}

// ==================== éšŠä¼ç®¡ç† ====================
function renderAvailableChars(){
  const filterName = document.getElementById('teamFilterName')?.value.toLowerCase() || '';
  const filterJob = document.getElementById('teamFilterJob')?.value || '';
  const filterDay = document.getElementById('teamFilterDay')?.value || '';
  
  // éæ¿¾å¯ç”¨è§’è‰²
  const availableChars = chars.filter(c => {
    const times = c.times !== undefined ? c.times : 0;
    const days = c.days || ['å…¨é€±'];
    
    // å ´æ¬¡ç‚º0çš„è§’è‰²ä¸é¡¯ç¤º
    if(times === 0) return false;
    
    // è¨ˆç®—è§’è‰²å·²ç¶“åœ¨å¹¾å€‹éšŠä¼ä¸­
    const teamsCount = teams.filter(t => t.members.includes(c.id)).length;
    
    // æ ¹æ“šå ´æ¬¡åˆ¤æ–·æ˜¯å¦é‚„èƒ½åŠ å…¥æ›´å¤šéšŠä¼
    // 7å ´ = æœ€å¤š1å€‹éšŠä¼, 14å ´ = æœ€å¤š2å€‹éšŠä¼
    let maxTeams = 0;
    if(times === 7) maxTeams = 1;
    else if(times === 14) maxTeams = 2;
    
    // å¦‚æœå·²ç¶“é”åˆ°ä¸Šé™ï¼Œä¸é¡¯ç¤º
    if(teamsCount >= maxTeams) return false;
    
    const matchName = c.name.toLowerCase().includes(filterName);
    const matchJob = !filterJob || c.job === filterJob;
    const matchDay = !filterDay || days.includes(filterDay) || days.includes('å…¨é€±');
    
    return matchName && matchJob && matchDay;
  });
  
  const html = availableChars.map(c => {
    const days = c.days || ['å…¨é€±'];
    const times = c.times !== undefined ? c.times : 0;
    const timeSlot = c.timeSlot || '';
    
    // è¨ˆç®—è§’è‰²å·²åœ¨å¹¾å€‹éšŠä¼
    const teamsCount = teams.filter(t => t.members.includes(c.id)).length;
    let maxTeams = 0;
    if(times === 7) maxTeams = 1;
    else if(times === 14) maxTeams = 2;
    
    return `
    <div class="char-card" draggable="true" data-char-id="${c.id}">
      <div class="char-header">
        <div>
          <div class="char-name">${c.name}</div>
          <span class="char-job">${c.job || 'æœªåˆ†é¡'}</span>
        </div>
      </div>
      <div class="char-level">ç­‰ç´š ${c.level}</div>
      ${c.damage ? `<div class="char-damage">ğŸ’¥ ${c.damage}</div>` : ''}
      <div class="char-days">
        ${days.map(d => `<span class="day-badge">${d}</span>`).join('')}
      </div>
      ${timeSlot ? `<div class="char-time">â° ${timeSlot}</div>` : ''}
      <div class="char-time">ğŸ® æ¯é€± ${times} å ´ (${teamsCount}/${maxTeams}éšŠ)</div>
    </div>
  `}).join('');
  
  document.getElementById('availableChars').innerHTML = html || '<p style="text-align:center;color:var(--muted);padding:40px">æ²’æœ‰å¯ç”¨è§’è‰²<br><small>å ´æ¬¡ç‚º0æˆ–å·²é”éšŠä¼ä¸Šé™çš„è§’è‰²ä¸æœƒé¡¯ç¤º</small></p>';
  
  setupDragDrop();
}

function renderTeams(){
  const html = teams.map((team, idx) => `
    <div class="team-card" data-team-id="${idx}">
      <div class="team-header">
        <div class="team-title">éšŠä¼ ${idx + 1}</div>
        <div>
          <span class="team-count">${team.members.length}/6 äºº</span>
          <button class="btn-danger btn-small" style="margin-left:8px" onclick="removeTeam(${idx})">åˆªé™¤éšŠä¼</button>
        </div>
      </div>
      <div class="team-members" data-team-id="${idx}">
        ${team.members.map(mid => {
          const char = chars.find(c => c.id === mid);
          if(!char) return '';
          
          // è¨ˆç®—è§’è‰²åœ¨å¹¾å€‹éšŠä¼ä¸­
          const teamsCount = teams.filter(t => t.members.includes(mid)).length;
          const times = char.times !== undefined ? char.times : 0;
          let maxTeams = 0;
          if(times === 7) maxTeams = 1;
          else if(times === 14) maxTeams = 2;
          
          return `
            <div class="member-item" draggable="true" data-char-id="${mid}">
              <div class="member-info">
                <span class="member-name">${char.name}</span>
                <div class="member-meta">
                  <span>${char.job}</span>
                  <span>Lv.${char.level}</span>
                  ${char.damage ? `<span>${char.damage}</span>` : ''}
                  <span style="color:${teamsCount >= maxTeams ? '#fbbf24' : 'var(--accent)'}">(${teamsCount}/${maxTeams}éšŠ)</span>
                </div>
              </div>
              <button class="remove-member" onclick="removeFromTeam(${idx}, ${mid})">ç§»é™¤</button>
            </div>
          `;
        }).join('')}
      </div>
    </div>
  `).join('');
  
  document.getElementById('teamsContainer').innerHTML = html || '<p style="text-align:center;color:var(--muted);padding:40px">å°šæœªå»ºç«‹éšŠä¼<br><small>é»æ“Šã€Œæ–°å¢éšŠä¼ã€é–‹å§‹çµ„éšŠ</small></p>';
  
  setupTeamDragDrop();
}

function addTeam(){
  teams.push({ members: [] });
  saveToLocal();
  renderTeams();
}

function removeTeam(idx){
  if(!confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹éšŠä¼å—ï¼Ÿ')){
    return;
  }
  teams.splice(idx, 1);
  saveToLocal();
  renderTeams();
  renderAvailableChars();
}

function removeFromTeam(teamIdx, charId){
  teams[teamIdx].members = teams[teamIdx].members.filter(mid => mid !== charId);
  saveToLocal();
  renderTeams();
  renderAvailableChars();
}

function clearAllTeams(){
  if(!confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰éšŠä¼å—ï¼Ÿ\n\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')){
    return;
  }
  teams = [];
  saveToLocal();
  renderTeams();
  renderAvailableChars();
}

// ==================== æ‹–æ”¾åŠŸèƒ½ ====================
let draggedChar = null;

function setupDragDrop(){
  const charCards = document.querySelectorAll('.char-card[draggable="true"]');
  
  charCards.forEach(card => {
    card.addEventListener('dragstart', e => {
      draggedChar = parseInt(e.target.dataset.charId);
      e.target.classList.add('dragging');
    });
    
    card.addEventListener('dragend', e => {
      e.target.classList.remove('dragging');
      draggedChar = null;
    });
  });
}

function setupTeamDragDrop(){
  const teamContainers = document.querySelectorAll('.team-members');
  
  teamContainers.forEach(container => {
    container.addEventListener('dragover', e => {
      e.preventDefault();
      container.parentElement.classList.add('drag-over');
    });
    
    container.addEventListener('dragleave', e => {
      if(e.target === container){
        container.parentElement.classList.remove('drag-over');
      }
    });
    
    container.addEventListener('drop', e => {
      e.preventDefault();
      container.parentElement.classList.remove('drag-over');
      
      if(draggedChar === null) return;
      
      const teamIdx = parseInt(container.dataset.teamId);
      const team = teams[teamIdx];
      
      if(team.members.length >= 6){
        alert('æ­¤éšŠä¼å·²æ»¿ï¼ˆæœ€å¤š6äººï¼‰ï¼');
        return;
      }
      
      if(team.members.includes(draggedChar)){
        alert('æ­¤è§’è‰²å·²åœ¨éšŠä¼ä¸­ï¼');
        return;
      }
      
      // æª¢æŸ¥è§’è‰²çš„å ´æ¬¡é™åˆ¶
      const char = chars.find(c => c.id === draggedChar);
      if(char){
        const times = char.times !== undefined ? char.times : 0;
        const currentTeamsCount = teams.filter(t => t.members.includes(draggedChar)).length;
        
        let maxTeams = 0;
        if(times === 7) maxTeams = 1;
        else if(times === 14) maxTeams = 2;
        
        if(currentTeamsCount >= maxTeams){
          alert(`æ­¤è§’è‰²æ¯é€±${times}å ´ï¼Œæœ€å¤šåªèƒ½åŠ å…¥${maxTeams}å€‹éšŠä¼ï¼\nç›®å‰å·²åœ¨${currentTeamsCount}å€‹éšŠä¼ä¸­ã€‚`);
          return;
        }
      }
      
      team.members.push(draggedChar);
      saveToLocal();
      renderTeams();
      renderAvailableChars();
    });
  });
  
  // è¨­å®šæˆå“¡é …ç›®çš„æ‹–æ”¾
  const memberItems = document.querySelectorAll('.member-item[draggable="true"]');
  memberItems.forEach(item => {
    item.addEventListener('dragstart', e => {
      draggedChar = parseInt(e.target.dataset.charId);
      e.target.classList.add('dragging');
    });
    
    item.addEventListener('dragend', e => {
      e.target.classList.remove('dragging');
      draggedChar = null;
    });
  });
}

// ==================== å‡ºå¸­ç®¡ç† ====================
function renderAttendance(){
  document.getElementById('currentWeekDisplay').textContent = getWeekDisplay(currentWeekKey);
  
  if(!attendance[currentWeekKey]){
    attendance[currentWeekKey] = {};
  }
  
  const weekData = attendance[currentWeekKey];
  const prevWeekKey = getPreviousWeekKey(currentWeekKey);
  const prevWeekData = attendance[prevWeekKey] || {};
  
  // æª¢æŸ¥æ˜¯å¦ç‚ºé€±ä¸€ï¼Œå¦‚æœæ˜¯å‰‡è‡ªå‹•æ›´æ–°ä¸Šé€±ç­‰ç´š
  checkAndUpdateWeeklyLevels();
  
  const html = chars.map(c => {
    const data = weekData[c.id] || { 
      trained: false, 
      currentLevel: '', 
      lastWeekLevel: '', // æ–°å¢ä¸Šé€±ç­‰ç´šæ¬„ä½
      onLeave: false, 
      returnDate: '', 
      notes: '' 
    };
    
    // å¦‚æœè³‡æ–™ä¸å­˜åœ¨ï¼Œåˆå§‹åŒ–
    if(!weekData[c.id]){
      weekData[c.id] = data;
    }
    
    // å–å¾—ä¸Šé€±ç­‰ç´š
    const lastWeekLevel = data.lastWeekLevel || '';
    
    // è¨ˆç®—ç­‰ç´šè®ŠåŒ–
    const currentLevel = data.currentLevel;
    let levelCompare = '';
    let autoTrained = false; // è‡ªå‹•åˆ¤æ–·æ˜¯å¦ç·´åŠŸ
    
    if(currentLevel !== '' && lastWeekLevel !== ''){
      const diff = currentLevel - lastWeekLevel;
      if(diff > 0){
        levelCompare = `<span class="level-up">â–²${diff}</span>`;
        autoTrained = true; // ç­‰ç´šæå‡ï¼Œè‡ªå‹•æ¨™è¨˜ç‚ºå·²ç·´åŠŸ
      } else if(diff < 0){
        levelCompare = `<span class="level-down">â–¼${Math.abs(diff)}</span>`;
      } else {
        levelCompare = `<span class="level-same">â”</span>`;
      }
    }
    
    // æ›´æ–°è‡ªå‹•åˆ¤æ–·çš„ç·´åŠŸç‹€æ…‹
    weekData[c.id].trained = autoTrained;
    
    const onLeaveClass = data.onLeave ? 'on-leave' : '';
    
    return `
      <tr class="${onLeaveClass}">
        <td>
          <div class="attendance-name">
            ${c.name}
            ${data.onLeave ? `<span class="leave-badge">è«‹å‡</span>` : ''}
          </div>
        </td>
        <td>
          <span class="attendance-role" onclick="editCharRole(${c.id})" style="cursor:pointer" title="é»æ“Šä¿®æ”¹èº«ä»½">
            ${c.role || 'æˆå“¡'}
          </span>
        </td>
        <td>
          <input 
            type="number" 
            class="level-input" 
            value="${lastWeekLevel}" 
            placeholder="ç©ºç™½"
            onchange="updateLastWeekLevel(${c.id}, this.value)"
            min="1"
            max="300"
            style="background:rgba(255,255,255,0.03)"
          />
        </td>
        <td>
          <input 
            type="number" 
            class="level-input" 
            value="${currentLevel}" 
            placeholder="ç©ºç™½"
            onchange="updateLevel(${c.id}, this.value)"
            min="1"
            max="300"
          />
          ${levelCompare}
        </td>
        <td>
          <div 
            class="status-toggle ${autoTrained ? 'active' : ''}" 
            style="cursor:default;pointer-events:none;${autoTrained ? 'opacity:1' : 'opacity:0.6'}"
            title="æ­¤ç‹€æ…‹ç”±ç³»çµ±è‡ªå‹•åˆ¤æ–·ï¼ˆç­‰ç´šæå‡=å·²ç·´åŠŸï¼‰"
          >
            ${autoTrained ? 'âœ“ å·²ç·´åŠŸ' : 'æœªç·´åŠŸ'}
          </div>
        </td>
        <td>
          <button 
            class="status-toggle ${data.onLeave ? 'active' : ''}" 
            style="${data.onLeave ? 'background:linear-gradient(135deg,#ff6b6b,#ee5a6f);color:#fff' : ''}"
            onclick="toggleLeaveStatus(${c.id})"
          >
            ${data.onLeave ? 'âœ“ è«‹å‡ä¸­' : 'æœªè«‹å‡'}
          </button>
          ${data.onLeave && data.returnDate ? `<div class="return-date">å›æ­¸ï¼š${data.returnDate}</div>` : ''}
        </td>
        <td>
          <input 
            type="text" 
            class="notes-input" 
            value="${data.notes || ''}" 
            placeholder="è¼¸å…¥å‚™è¨»..."
            onchange="updateNotes(${c.id}, this.value)"
          />
        </td>
        <td>
          <div class="action-cell">
            <button class="btn-small" onclick="editChar(${c.id})">ç·¨è¼¯è§’è‰²</button>
            <button class="btn-small btn-delete-data" onclick="deleteAttendanceData(${c.id})">åˆªé™¤è§’è‰²</button>
          </div>
        </td>
      </tr>
    `;
  }).join('');
  
  document.getElementById('attendanceBody').innerHTML = html || '<tr><td colspan="8" style="text-align:center;padding:40px;color:var(--muted)">å°šç„¡è§’è‰²è³‡æ–™</td></tr>';
  
  // å„²å­˜è‡ªå‹•æ›´æ–°çš„ç·´åŠŸç‹€æ…‹
  saveToLocal();
}

function updateLastWeekLevel(charId, newLevel){
  const char = chars.find(c => c.id === charId);
  if(!char) return;
  
  if(!attendance[currentWeekKey]){
    attendance[currentWeekKey] = {};
  }
  if(!attendance[currentWeekKey][charId]){
    attendance[currentWeekKey][charId] = { 
      trained: false, 
      currentLevel: '', 
      lastWeekLevel: '',
      onLeave: false, 
      returnDate: '', 
      notes: '' 
    };
  }
  
  // è™•ç†ç©ºç™½è¼¸å…¥
  if(newLevel === '' || newLevel === null){
    attendance[currentWeekKey][charId].lastWeekLevel = '';
  } else {
    const newLevelNum = parseInt(newLevel) || 0;
    attendance[currentWeekKey][charId].lastWeekLevel = newLevelNum;
  }
  
  saveToLocal();
  renderAttendance();
}

function checkAndUpdateWeeklyLevels(){
  // æª¢æŸ¥ä»Šå¤©æ˜¯å¦ç‚ºé€±ä¸€
  const today = new Date();
  const dayOfWeek = today.getDay(); // 0=é€±æ—¥, 1=é€±ä¸€, ...
  
  // å–å¾—ä¸Šæ¬¡æª¢æŸ¥çš„æ—¥æœŸ
  const lastCheck = localStorage.getItem('lastWeeklyCheck');
  const todayStr = today.toISOString().split('T')[0];
  
  // å¦‚æœæ˜¯é€±ä¸€ä¸”é‚„æ²’æœ‰åŸ·è¡Œéæœ¬é€±çš„æ›´æ–°
  if(dayOfWeek === 1 && lastCheck !== todayStr){
    if(!attendance[currentWeekKey]){
      attendance[currentWeekKey] = {};
    }
    
    // å°‡ç¾åœ¨ç­‰ç´šè‡ªå‹•è½‰ç‚ºä¸Šé€±ç­‰ç´š
    chars.forEach(c => {
      if(attendance[currentWeekKey][c.id]){
        const currentLevel = attendance[currentWeekKey][c.id].currentLevel;
        if(currentLevel !== '' && currentLevel !== null){
          attendance[currentWeekKey][c.id].lastWeekLevel = currentLevel;
          // æ¸…ç©ºç¾åœ¨ç­‰ç´šï¼Œæº–å‚™è¼¸å…¥æ–°çš„ä¸€é€±çš„ç­‰ç´š
          // attendance[currentWeekKey][c.id].currentLevel = '';
        }
      }
    });
    
    // è¨˜éŒ„æœ¬æ¬¡æª¢æŸ¥æ—¥æœŸ
    localStorage.setItem('lastWeeklyCheck', todayStr);
    saveToLocal();
  }
}

function updateLevel(charId, newLevel){
  const char = chars.find(c => c.id === charId);
  if(!char) return;
  
  if(!attendance[currentWeekKey]){
    attendance[currentWeekKey] = {};
  }
  if(!attendance[currentWeekKey][charId]){
    attendance[currentWeekKey][charId] = { 
      trained: false, 
      currentLevel: '', 
      lastWeekLevel: '',
      onLeave: false, 
      returnDate: '', 
      notes: '' 
    };
  }
  
  // è™•ç†ç©ºç™½è¼¸å…¥
  if(newLevel === '' || newLevel === null){
    attendance[currentWeekKey][charId].currentLevel = '';
    saveToLocal();
    renderAttendance();
    return;
  }
  
  const newLevelNum = parseInt(newLevel) || 0;
  
  // æ›´æ–°ç­‰ç´š
  attendance[currentWeekKey][charId].currentLevel = newLevelNum;
  
  // ç·´åŠŸç‹€æ…‹æœƒåœ¨ renderAttendance ä¸­è‡ªå‹•åˆ¤æ–·
  
  saveToLocal();
  renderAttendance();
}

function toggleLeaveStatus(charId){
  if(!attendance[currentWeekKey]){
    attendance[currentWeekKey] = {};
  }
  if(!attendance[currentWeekKey][charId]){
    const char = chars.find(c => c.id === charId);
    attendance[currentWeekKey][charId] = { 
      trained: false, 
      currentLevel: '', 
      lastWeekLevel: '',
      onLeave: false, 
      returnDate: '', 
      notes: '' 
    };
  }
  
  const wasOnLeave = attendance[currentWeekKey][charId].onLeave;
  attendance[currentWeekKey][charId].onLeave = !wasOnLeave;
  
  // å¦‚æœè¨­ç‚ºè«‹å‡ï¼Œè©¢å•å›æ­¸æ—¥æœŸ
  if(!wasOnLeave){
    const returnDate = prompt('é è¨ˆå›æ­¸æ—¥æœŸï¼ˆé¸å¡«ï¼Œæ ¼å¼ï¼š2024-12-31ï¼‰ï¼š');
    if(returnDate){
      attendance[currentWeekKey][charId].returnDate = returnDate;
    }
  } else {
    attendance[currentWeekKey][charId].returnDate = '';
  }
  
  saveToLocal();
  renderAttendance();
}

function updateNotes(charId, notes){
  if(!attendance[currentWeekKey]){
    attendance[currentWeekKey] = {};
  }
  if(!attendance[currentWeekKey][charId]){
    attendance[currentWeekKey][charId] = { 
      trained: false, 
      currentLevel: '', 
      lastWeekLevel: '',
      onLeave: false, 
      returnDate: '', 
      notes: '' 
    };
  }
  
  attendance[currentWeekKey][charId].notes = notes;
  saveToLocal();
}

function deleteAttendanceData(charId){
  const char = chars.find(c => c.id === charId);
  const charName = char ? char.name : 'æ­¤è§’è‰²';
  
  if(!confirm(`ç¢ºå®šè¦å®Œå…¨åˆªé™¤ã€Œ${charName}ã€å—ï¼Ÿ\n\né€™å°‡åˆªé™¤ï¼š\nãƒ»è§’è‰²åŸºæœ¬è³‡æ–™\nãƒ»æ‰€æœ‰å‡ºå¸­è¨˜éŒ„\nãƒ»éšŠä¼ä¸­çš„æˆå“¡è³‡æ–™\n\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`)){
    return;
  }
  
  // 1. å¾è§’è‰²åˆ—è¡¨ä¸­åˆªé™¤
  chars = chars.filter(c => c.id !== charId);
  
  // 2. å¾æ‰€æœ‰éšŠä¼ä¸­ç§»é™¤
  teams.forEach(team => {
    team.members = team.members.filter(mid => mid !== charId);
  });
  
  // 3. åˆªé™¤æ‰€æœ‰é€±æ¬¡ä¸­çš„å‡ºå¸­è³‡æ–™
  Object.keys(attendance).forEach(weekKey => {
    if(attendance[weekKey][charId]){
      delete attendance[weekKey][charId];
    }
  });
  
  saveToLocal();
  renderChars();
  renderTeams();
  renderAvailableChars();
  renderAttendance();
  alert(`ã€Œ${charName}ã€å·²å®Œå…¨åˆªé™¤ï¼`);
}

function editCharRole(charId){
  const char = chars.find(c => c.id === charId);
  if(!char) return;
  
  const roles = ['æœƒé•·', 'å‰¯æœƒ', 'å¹¹éƒ¨', 'æˆå“¡', 'æ–°äºº'];
  const currentRole = char.role || 'æˆå“¡';
  
  let roleOptions = '';
  roles.forEach(role => {
    roleOptions += `\n${role === currentRole ? 'â—' : 'â—‹'} ${role}`;
  });
  
  const newRole = prompt(`é¸æ“‡èº«ä»½ï¼š${roleOptions}\n\nè«‹è¼¸å…¥æ–°èº«ä»½ï¼š`, currentRole);
  
  if(newRole && roles.includes(newRole)){
    char.role = newRole;
    saveToLocal();
    renderAttendance();
  }
}

function batchUpdateLevels(){
  const confirmUpdate = confirm('æ‰¹é‡æ›´æ–°ç­‰ç´šåŠŸèƒ½ï¼š\n\næ­¤åŠŸèƒ½æœƒå°‡æ‰€æœ‰è§’è‰²çš„ã€Œç¾åœ¨ç­‰ç´šã€æ›´æ–°ç‚ºè§’è‰²è³‡æ–™ä¸­çš„ç­‰ç´šã€‚\n\nç¢ºå®šè¦åŸ·è¡Œå—ï¼Ÿ');
  if(!confirmUpdate) return;
  
  if(!attendance[currentWeekKey]){
    attendance[currentWeekKey] = {};
  }
  
  chars.forEach(c => {
    if(!attendance[currentWeekKey][c.id]){
      attendance[currentWeekKey][c.id] = { 
        trained: false, 
        currentLevel: c.level, 
        lastWeekLevel: '',
        onLeave: false, 
        returnDate: '', 
        notes: '' 
      };
    } else {
      attendance[currentWeekKey][c.id].currentLevel = c.level;
    }
  });
  
  saveToLocal();
  renderAttendance();
  alert('æ‰¹é‡æ›´æ–°å®Œæˆï¼');
}

function generateWeeklyReport(){
  const weekData = attendance[currentWeekKey] || {};
  
  let report = `ğŸ“Š ${getWeekDisplay(currentWeekKey)} å…¬æœƒé€±å ±\n\n`;
  report += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
  
  // çµ±è¨ˆæ•¸æ“š
  let trainedCount = 0;
  let totalWeekGrowth = 0;
  let onLeaveCount = 0;
  
  chars.forEach(c => {
    const data = weekData[c.id] || {};
    
    // è‡ªå‹•åˆ¤æ–·æ˜¯å¦ç·´åŠŸ
    const currentLevel = data.currentLevel || '';
    const lastWeekLevel = data.lastWeekLevel || '';
    let autoTrained = false;
    if(currentLevel !== '' && lastWeekLevel !== ''){
      if(currentLevel > lastWeekLevel){
        autoTrained = true;
      }
    }
    
    if(autoTrained) trainedCount++;
    if(data.onLeave) onLeaveCount++;
    
    if(currentLevel !== '' && lastWeekLevel !== ''){
      const weeklyGrowth = currentLevel - lastWeekLevel;
      totalWeekGrowth += weeklyGrowth;
    }
  });
  
  const rate = chars.length > 0 ? Math.round((trainedCount / chars.length) * 100) : 0;
  
  report += `ğŸ“ˆ æ•´é«”æ•¸æ“š\n`;
  report += `ãƒ»ç¸½æˆå“¡æ•¸ï¼š${chars.length} äºº\n`;
  report += `ãƒ»ç·´åŠŸäººæ•¸ï¼š${trainedCount} äºº\n`;
  report += `ãƒ»ç·´åŠŸç‡ï¼š${rate}%\n`;
  report += `ãƒ»æœ¬é€±ç¸½æˆé•·ï¼š${totalWeekGrowth} ç´š\n`;
  report += `ãƒ»è«‹å‡äººæ•¸ï¼š${onLeaveCount} äºº\n\n`;
  
  // æˆé•·æ’è¡Œ
  const growthList = chars.map(c => {
    const currentLevel = weekData[c.id]?.currentLevel || '';
    const lastWeekLevel = weekData[c.id]?.lastWeekLevel || '';
    if(currentLevel === '' || lastWeekLevel === '') return null;
    const growth = currentLevel - lastWeekLevel;
    return { char: c, growth };
  }).filter(g => g && g.growth > 0).sort((a, b) => b.growth - a.growth).slice(0, 5);
  
  if(growthList.length > 0){
    report += `ğŸ† æœ¬é€±æˆé•·æ’è¡Œ\n`;
    growthList.forEach((g, idx) => {
      report += `${idx + 1}. ${g.char.name} +${g.growth} ç´š\n`;
    });
    report += `\n`;
  }
  
  // è«‹å‡åå–®
  const leaveList = chars.filter(c => weekData[c.id]?.onLeave);
  if(leaveList.length > 0){
    report += `ğŸ”´ è«‹å‡åå–®\n`;
    leaveList.forEach(c => {
      const data = weekData[c.id];
      report += `ãƒ»${c.name}`;
      if(data.returnDate) report += ` (é è¨ˆå›æ­¸ï¼š${data.returnDate})`;
      if(data.notes) report += ` - ${data.notes}`;
      report += `\n`;
    });
    report += `\n`;
  }
  
  report += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
  report += `ç”Ÿæˆæ™‚é–“ï¼š${new Date().toLocaleString('zh-TW')}\n`;
  
  // è¤‡è£½åˆ°å‰ªè²¼ç°¿
  navigator.clipboard.writeText(report).then(() => {
    alert('é€±å ±å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼\n\nå¯ä»¥ç›´æ¥è²¼åˆ° Discord æˆ–å…¶ä»–åœ°æ–¹ã€‚');
  }).catch(() => {
    // å¦‚æœè¤‡è£½å¤±æ•—ï¼Œé¡¯ç¤ºåœ¨å½ˆçª—ä¸­
    alert(report);
  });
}

function viewHistory(){
  alert('æ­·å²è¨˜éŒ„åŠŸèƒ½é–‹ç™¼ä¸­...\n\nå³å°‡æ¨å‡ºï¼š\nãƒ»æŸ¥çœ‹éå»å¹¾é€±çš„è³‡æ–™\nãƒ»å°æ¯”ä¸åŒé€±çš„æ•¸æ“š\nãƒ»æˆå“¡æˆé•·è¶¨å‹¢åœ–è¡¨');
}

function compareWeeks(){
  alert('é€±æ•¸å°æ¯”åŠŸèƒ½é–‹ç™¼ä¸­...\n\nå³å°‡æ¨å‡ºï¼š\nãƒ»é¸æ“‡å…©å€‹é€±æ¬¡é€²è¡Œå°æ¯”\nãƒ»æŸ¥çœ‹æˆå“¡ç­‰ç´šè®ŠåŒ–\nãƒ»åˆ†ææˆé•·è¶¨å‹¢');
}

// ==================== è³‡æ–™åŒ¯å‡ºåŒ¯å…¥ ====================
function deleteAllData(){
  const confirmDelete = confirm('âš ï¸ è­¦å‘Šï¼šåˆªé™¤å…¨éƒ¨è³‡æ–™\n\næ­¤æ“ä½œå°‡åˆªé™¤ï¼š\nãƒ»æ‰€æœ‰è§’è‰²è³‡æ–™\nãƒ»æ‰€æœ‰éšŠä¼é…ç½®\nãƒ»æ‰€æœ‰å‡ºå¸­è¨˜éŒ„\n\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼\n\nç¢ºå®šè¦åˆªé™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿ');
  
  if(!confirmDelete) return;
  
  const doubleConfirm = confirm('âš ï¸ æœ€å¾Œç¢ºèª\n\næ‚¨ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿ\né€™å€‹æ“ä½œçœŸçš„ç„¡æ³•å¾©åŸï¼');
  
  if(!doubleConfirm) return;
  
  // æ¸…ç©ºæ‰€æœ‰è³‡æ–™
  chars = [];
  teams = [];
  attendance = {};
  
  // æ¸…ç©º localStorage
  localStorage.removeItem('msChars');
  localStorage.removeItem('msTeams');
  localStorage.removeItem('msAttendance');
  localStorage.removeItem('lastWeeklyCheck');
  
  // é‡æ–°æ¸²æŸ“æ‰€æœ‰é é¢
  renderChars();
  renderTeams();
  renderAvailableChars();
  renderAttendance();
  
  alert('âœ“ æ‰€æœ‰è³‡æ–™å·²åˆªé™¤ï¼');
}

function exportData(){
  const data = {
    chars,
    teams,
    attendance,
    exportDate: new Date().toISOString()
  };
  
  const json = JSON.stringify(data, null, 2);
  const blob = new Blob([json], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `æ¥“ä¹‹è°·å…¬æœƒè³‡æ–™_${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  URL.revokeObjectURL(url);
}

function importData(){
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  
  input.onchange = e => {
    const file = e.target.files[0];
    if(!file) return;
    
    const reader = new FileReader();
    reader.onload = event => {
      try{
        const data = JSON.parse(event.target.result);
        
        if(!data.chars || !Array.isArray(data.chars)){
          throw new Error('è³‡æ–™æ ¼å¼éŒ¯èª¤');
        }
        
        const confirmImport = confirm(`ç¢ºå®šè¦åŒ¯å…¥è³‡æ–™å—ï¼Ÿ\n\næ­¤æ“ä½œå°‡è¦†è“‹ç¾æœ‰è³‡æ–™ï¼\n\nåŒ¯å…¥è³‡æ–™åŒ…å«ï¼š\nãƒ»${data.chars.length} å€‹è§’è‰²\nãƒ»${data.teams?.length || 0} å€‹éšŠä¼\nãƒ»${Object.keys(data.attendance || {}).length} é€±çš„å‡ºå¸­è¨˜éŒ„`);
        
        if(!confirmImport) return;
        
        // è³‡æ–™é·ç§»ï¼šè½‰æ›èˆŠæ ¼å¼åˆ°æ–°æ ¼å¼
        chars = data.chars.map(c => {
          // å°‡ availableDays è½‰æ›ç‚º days
          if(c.availableDays && !c.days){
            c.days = c.availableDays;
            delete c.availableDays;
          }
          // å°‡ timeStart è½‰æ›ç‚º timeSlot
          if(c.timeStart && !c.timeSlot){
            c.timeSlot = c.timeStart;
            delete c.timeStart;
            delete c.timeEnd;
          }
          // ç¢ºä¿ times æ¬„ä½å­˜åœ¨
          if(c.times === undefined){
            c.times = 0;
          }
          // ç¢ºä¿ days æ¬„ä½å­˜åœ¨ä¸”ä¸ç‚ºç©º
          if(!c.days || c.days.length === 0){
            c.days = ['å…¨é€±'];
          }
          return c;
        });
        
        teams = data.teams || [];
        attendance = data.attendance || {};
        
        // é·ç§»å‡ºå¸­è³‡æ–™æ ¼å¼
        Object.keys(attendance).forEach(weekKey => {
          Object.keys(attendance[weekKey]).forEach(charId => {
            const attData = attendance[weekKey][charId];
            // ç§»é™¤ inGuild æ¬„ä½
            if(attData.inGuild !== undefined){
              delete attData.inGuild;
            }
            // ç¢ºä¿æœ‰ lastWeekLevel æ¬„ä½
            if(attData.lastWeekLevel === undefined){
              attData.lastWeekLevel = '';
            }
            // ç¢ºä¿æœ‰ currentLevel æ¬„ä½
            if(attData.currentLevel === undefined){
              attData.currentLevel = '';
            }
          });
        });
        
        saveToLocal();
        renderChars();
        renderTeams();
        renderAvailableChars();
        renderAttendance();
        
        alert('è³‡æ–™åŒ¯å…¥æˆåŠŸï¼å·²è‡ªå‹•è½‰æ›ç‚ºæ–°æ ¼å¼ã€‚');
      } catch(err){
        alert('åŒ¯å…¥å¤±æ•—ï¼šè³‡æ–™æ ¼å¼éŒ¯èª¤ï¼\n\n' + err.message);
      }
    };
    reader.readAsText(file);
  };
  
  input.click();
}

// ==================== äº‹ä»¶ç›£è½ ====================
document.getElementById('addBtn').addEventListener('click', addChar);
document.getElementById('clearBtn').addEventListener('click', () => {
  document.getElementById('nameInput').value = '';
  document.getElementById('levelInput').value = '';
  document.getElementById('jobInput').value = '';
  document.getElementById('damageInput').value = '';
  setSelectedDays([]);
  document.getElementById('timeSlot').value = '';
  
  // é‡ç½®å ´æ¬¡é¸æ“‡ç‚º0å ´
  selectedTimes = 0;
  document.querySelectorAll('.times-btn').forEach(btn => {
    btn.classList.remove('active');
    if(btn.dataset.times === '0'){
      btn.classList.add('active');
    }
  });
  
  document.getElementById('nameInput').focus();
});

document.getElementById('filterName').addEventListener('input', renderChars);
document.getElementById('filterJob').addEventListener('change', renderChars);

// éšŠä¼ç®¡ç†é é¢çš„æœå°‹
const teamFilterInput = document.getElementById('teamFilterName');
if(teamFilterInput){
  teamFilterInput.addEventListener('input', renderAvailableChars);
}

const teamFilterJob = document.getElementById('teamFilterJob');
if(teamFilterJob){
  teamFilterJob.addEventListener('change', renderAvailableChars);
}

const teamFilterDay = document.getElementById('teamFilterDay');
if(teamFilterDay){
  teamFilterDay.addEventListener('change', renderAvailableChars);
}

document.addEventListener('keydown', e => {
  if(e.key === 'Escape' && document.getElementById('editModal').classList.contains('show')){
    closeEditModal();
  }
});

document.getElementById('editModal').addEventListener('click', e => {
  if(e.target === document.getElementById('editModal')){
    closeEditModal();
  }
});

document.getElementById('nameInput').addEventListener('keypress', e => {
  if(e.key === 'Enter') addChar();
});

// å…¨é€±è¤‡é¸æ¡†é‚è¼¯
document.getElementById('dayAll').addEventListener('change', (e) => {
  if(e.target.checked){
    for(let i = 1; i <= 7; i++){
      document.getElementById(`day${i}`).checked = false;
    }
  }
});

for(let i = 1; i <= 7; i++){
  document.getElementById(`day${i}`).addEventListener('change', (e) => {
    if(e.target.checked){
      document.getElementById('dayAll').checked = false;
    }
  });
}

document.getElementById('editDayAll').addEventListener('change', (e) => {
  if(e.target.checked){
    for(let i = 1; i <= 7; i++){
      document.getElementById(`editDay${i}`).checked = false;
    }
  }
});

for(let i = 1; i <= 7; i++){
  document.getElementById(`editDay${i}`).addEventListener('change', (e) => {
    if(e.target.checked){
      document.getElementById('editDayAll').checked = false;
    }
  });
}

// ==================== åˆå§‹åŒ– ====================
loadFromLocal();
</script>

</body>
</html>
